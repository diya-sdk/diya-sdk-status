!function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n||e)},l,l.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){(function(process){function useColors(){return!("undefined"==typeof window||!window.process||"renderer"!==window.process.type)||("undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/))}function formatArgs(args){var useColors=this.useColors;if(args[0]=(useColors?"%c":"")+this.namespace+(useColors?" %c":" ")+args[0]+(useColors?"%c ":" ")+"+"+exports.humanize(this.diff),useColors){var c="color: "+this.color;args.splice(1,0,c,"color: inherit");var index=0,lastC=0;args[0].replace(/%[a-zA-Z%]/g,function(match){"%%"!==match&&(index++,"%c"===match&&(lastC=index))}),args.splice(lastC,0,c)}}function log(){return"object"==typeof console&&console.log&&Function.prototype.apply.call(console.log,console,arguments)}function save(namespaces){try{null==namespaces?exports.storage.removeItem("debug"):exports.storage.debug=namespaces}catch(e){}}function load(){var r;try{r=exports.storage.debug}catch(e){}return!r&&void 0!==process&&"env"in process&&(r=process.env.DEBUG),r}exports=module.exports=require("./debug"),exports.log=log,exports.formatArgs=formatArgs,exports.save=save,exports.load=load,exports.useColors=useColors,exports.storage="undefined"!=typeof chrome&&void 0!==chrome.storage?chrome.storage.local:function(){try{return window.localStorage}catch(e){}}(),exports.colors=["lightseagreen","forestgreen","goldenrod","dodgerblue","darkorchid","crimson"],exports.formatters.j=function(v){try{return JSON.stringify(v)}catch(err){return"[UnexpectedJSONParseError]: "+err.message}},exports.enable(load())}).call(this,require("_process"))},{"./debug":2,_process:5}],2:[function(require,module,exports){function selectColor(namespace){var i,hash=0;for(i in namespace)hash=(hash<<5)-hash+namespace.charCodeAt(i),hash|=0;return exports.colors[Math.abs(hash)%exports.colors.length]}function createDebug(namespace){function debug(){if(debug.enabled){var self=debug,curr=+new Date,ms=curr-(prevTime||curr);self.diff=ms,self.prev=prevTime,self.curr=curr,prevTime=curr;for(var args=new Array(arguments.length),i=0;i<args.length;i++)args[i]=arguments[i];args[0]=exports.coerce(args[0]),"string"!=typeof args[0]&&args.unshift("%O");var index=0;args[0]=args[0].replace(/%([a-zA-Z%])/g,function(match,format){if("%%"===match)return match;index++;var formatter=exports.formatters[format];if("function"==typeof formatter){var val=args[index];match=formatter.call(self,val),args.splice(index,1),index--}return match}),exports.formatArgs.call(self,args);(debug.log||exports.log||console.log.bind(console)).apply(self,args)}}return debug.namespace=namespace,debug.enabled=exports.enabled(namespace),debug.useColors=exports.useColors(),debug.color=selectColor(namespace),"function"==typeof exports.init&&exports.init(debug),debug}function enable(namespaces){exports.save(namespaces),exports.names=[],exports.skips=[];for(var split=("string"==typeof namespaces?namespaces:"").split(/[\s,]+/),len=split.length,i=0;i<len;i++)split[i]&&(namespaces=split[i].replace(/\*/g,".*?"),"-"===namespaces[0]?exports.skips.push(new RegExp("^"+namespaces.substr(1)+"$")):exports.names.push(new RegExp("^"+namespaces+"$")))}function disable(){exports.enable("")}function enabled(name){var i,len;for(i=0,len=exports.skips.length;i<len;i++)if(exports.skips[i].test(name))return!1;for(i=0,len=exports.names.length;i<len;i++)if(exports.names[i].test(name))return!0;return!1}function coerce(val){return val instanceof Error?val.stack||val.message:val}exports=module.exports=createDebug.debug=createDebug.default=createDebug,exports.coerce=coerce,exports.disable=disable,exports.enable=enable,exports.enabled=enabled,exports.humanize=require("ms"),exports.names=[],exports.skips=[],exports.formatters={};var prevTime},{ms:4}],3:[function(require,module,exports){"use strict";function Events(){}function EE(fn,context,once){this.fn=fn,this.context=context,this.once=once||!1}function EventEmitter(){this._events=new Events,this._eventsCount=0}var has=Object.prototype.hasOwnProperty,prefix="~";Object.create&&(Events.prototype=Object.create(null),(new Events).__proto__||(prefix=!1)),EventEmitter.prototype.eventNames=function(){var events,name,names=[];if(0===this._eventsCount)return names;for(name in events=this._events)has.call(events,name)&&names.push(prefix?name.slice(1):name);return Object.getOwnPropertySymbols?names.concat(Object.getOwnPropertySymbols(events)):names},EventEmitter.prototype.listeners=function(event,exists){var evt=prefix?prefix+event:event,available=this._events[evt];if(exists)return!!available;if(!available)return[];if(available.fn)return[available.fn];for(var i=0,l=available.length,ee=new Array(l);i<l;i++)ee[i]=available[i].fn;return ee},EventEmitter.prototype.emit=function(event,a1,a2,a3,a4,a5){var evt=prefix?prefix+event:event;if(!this._events[evt])return!1;var args,i,listeners=this._events[evt],len=arguments.length;if(listeners.fn){switch(listeners.once&&this.removeListener(event,listeners.fn,void 0,!0),len){case 1:return listeners.fn.call(listeners.context),!0;case 2:return listeners.fn.call(listeners.context,a1),!0;case 3:return listeners.fn.call(listeners.context,a1,a2),!0;case 4:return listeners.fn.call(listeners.context,a1,a2,a3),!0;case 5:return listeners.fn.call(listeners.context,a1,a2,a3,a4),!0;case 6:return listeners.fn.call(listeners.context,a1,a2,a3,a4,a5),!0}for(i=1,args=new Array(len-1);i<len;i++)args[i-1]=arguments[i];listeners.fn.apply(listeners.context,args)}else{var j,length=listeners.length;for(i=0;i<length;i++)switch(listeners[i].once&&this.removeListener(event,listeners[i].fn,void 0,!0),len){case 1:listeners[i].fn.call(listeners[i].context);break;case 2:listeners[i].fn.call(listeners[i].context,a1);break;case 3:listeners[i].fn.call(listeners[i].context,a1,a2);break;case 4:listeners[i].fn.call(listeners[i].context,a1,a2,a3);break;default:if(!args)for(j=1,args=new Array(len-1);j<len;j++)args[j-1]=arguments[j];listeners[i].fn.apply(listeners[i].context,args)}}return!0},EventEmitter.prototype.on=function(event,fn,context){var listener=new EE(fn,context||this),evt=prefix?prefix+event:event;return this._events[evt]?this._events[evt].fn?this._events[evt]=[this._events[evt],listener]:this._events[evt].push(listener):(this._events[evt]=listener,this._eventsCount++),this},EventEmitter.prototype.once=function(event,fn,context){var listener=new EE(fn,context||this,!0),evt=prefix?prefix+event:event;return this._events[evt]?this._events[evt].fn?this._events[evt]=[this._events[evt],listener]:this._events[evt].push(listener):(this._events[evt]=listener,this._eventsCount++),this},EventEmitter.prototype.removeListener=function(event,fn,context,once){var evt=prefix?prefix+event:event;if(!this._events[evt])return this;if(!fn)return 0==--this._eventsCount?this._events=new Events:delete this._events[evt],this;var listeners=this._events[evt];if(listeners.fn)listeners.fn!==fn||once&&!listeners.once||context&&listeners.context!==context||(0==--this._eventsCount?this._events=new Events:delete this._events[evt]);else{for(var i=0,events=[],length=listeners.length;i<length;i++)(listeners[i].fn!==fn||once&&!listeners[i].once||context&&listeners[i].context!==context)&&events.push(listeners[i]);events.length?this._events[evt]=1===events.length?events[0]:events:0==--this._eventsCount?this._events=new Events:delete this._events[evt]}return this},EventEmitter.prototype.removeAllListeners=function(event){var evt;return event?(evt=prefix?prefix+event:event,this._events[evt]&&(0==--this._eventsCount?this._events=new Events:delete this._events[evt])):(this._events=new Events,this._eventsCount=0),this},EventEmitter.prototype.off=EventEmitter.prototype.removeListener,EventEmitter.prototype.addListener=EventEmitter.prototype.on,EventEmitter.prototype.setMaxListeners=function(){return this},EventEmitter.prefixed=prefix,EventEmitter.EventEmitter=EventEmitter,void 0!==module&&(module.exports=EventEmitter)},{}],4:[function(require,module,exports){function parse(str){if(str=String(str),!(str.length>100)){var match=/^((?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|years?|yrs?|y)?$/i.exec(str);if(match){var n=parseFloat(match[1]);switch((match[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return n*y;case"days":case"day":case"d":return n*d;case"hours":case"hour":case"hrs":case"hr":case"h":return n*h;case"minutes":case"minute":case"mins":case"min":case"m":return n*m;case"seconds":case"second":case"secs":case"sec":case"s":return n*s;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return n;default:return}}}}function fmtShort(ms){return ms>=d?Math.round(ms/d)+"d":ms>=h?Math.round(ms/h)+"h":ms>=m?Math.round(ms/m)+"m":ms>=s?Math.round(ms/s)+"s":ms+"ms"}function fmtLong(ms){return plural(ms,d,"day")||plural(ms,h,"hour")||plural(ms,m,"minute")||plural(ms,s,"second")||ms+" ms"}function plural(ms,n,name){if(!(ms<n))return ms<1.5*n?Math.floor(ms/n)+" "+name:Math.ceil(ms/n)+" "+name+"s"}var s=1e3,m=60*s,h=60*m,d=24*h,y=365.25*d;module.exports=function(val,options){options=options||{};var type=typeof val;if("string"===type&&val.length>0)return parse(val);if("number"===type&&!1===isNaN(val))return options.long?fmtLong(val):fmtShort(val);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(val))}},{}],5:[function(require,module,exports){function defaultSetTimout(){throw new Error("setTimeout has not been defined")}function defaultClearTimeout(){throw new Error("clearTimeout has not been defined")}function runTimeout(fun){if(cachedSetTimeout===setTimeout)return setTimeout(fun,0);if((cachedSetTimeout===defaultSetTimout||!cachedSetTimeout)&&setTimeout)return cachedSetTimeout=setTimeout,setTimeout(fun,0);try{return cachedSetTimeout(fun,0)}catch(e){try{return cachedSetTimeout.call(null,fun,0)}catch(e){return cachedSetTimeout.call(this,fun,0)}}}function runClearTimeout(marker){if(cachedClearTimeout===clearTimeout)return clearTimeout(marker);if((cachedClearTimeout===defaultClearTimeout||!cachedClearTimeout)&&clearTimeout)return cachedClearTimeout=clearTimeout,clearTimeout(marker);try{return cachedClearTimeout(marker)}catch(e){try{return cachedClearTimeout.call(null,marker)}catch(e){return cachedClearTimeout.call(this,marker)}}}function cleanUpNextTick(){draining&&currentQueue&&(draining=!1,currentQueue.length?queue=currentQueue.concat(queue):queueIndex=-1,queue.length&&drainQueue())}function drainQueue(){if(!draining){var timeout=runTimeout(cleanUpNextTick);draining=!0;for(var len=queue.length;len;){for(currentQueue=queue,queue=[];++queueIndex<len;)currentQueue&&currentQueue[queueIndex].run();queueIndex=-1,len=queue.length}currentQueue=null,draining=!1,runClearTimeout(timeout)}}function Item(fun,array){this.fun=fun,this.array=array}function noop(){}var cachedSetTimeout,cachedClearTimeout,process=module.exports={};!function(){try{cachedSetTimeout="function"==typeof setTimeout?setTimeout:defaultSetTimout}catch(e){cachedSetTimeout=defaultSetTimout}try{cachedClearTimeout="function"==typeof clearTimeout?clearTimeout:defaultClearTimeout}catch(e){cachedClearTimeout=defaultClearTimeout}}();var currentQueue,queue=[],draining=!1,queueIndex=-1;process.nextTick=function(fun){var args=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)args[i-1]=arguments[i];queue.push(new Item(fun,args)),1!==queue.length||draining||runTimeout(drainQueue)},Item.prototype.run=function(){this.fun.apply(null,this.array)},process.title="browser",process.browser=!0,process.env={},process.argv=[],process.version="",process.versions={},process.on=noop,process.addListener=noop,process.once=noop,process.off=noop,process.removeListener=noop,process.removeAllListeners=noop,process.emit=noop,process.prependListener=noop,process.prependOnceListener=noop,process.listeners=function(name){return[]},process.binding=function(name){throw new Error("process.binding is not supported")},process.cwd=function(){return"/"},process.chdir=function(dir){throw new Error("process.chdir is not supported")},process.umask=function(){return 0}},{}],6:[function(require,module,exports){"use strict";!function(){var ConnectorV1=require("./v1/connector.js"),ConnectorV2=require("./v2/connector.js");d1.DiyaSelector.prototype.Status=function(){var _this=this;return new Promise(function(resolve,reject){_this.request({service:"status",func:"GetAPIVersion"},function(peerId,err,data){null==err?resolve(data):reject(err)})}).then(function(data){if(2===data)return new ConnectorV2(_this);throw new Error("Cannot instantiate connector")}).catch(function(err){if(err.includes("Method 'GetAPIVersion' not found in introspection data"))return new ConnectorV1(_this);throw new Error(err)})}}()},{"./v1/connector.js":7,"./v2/connector.js":8}],7:[function(require,module,exports){"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}var Promise,_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),isBrowser="undefined"!=typeof window;Promise=isBrowser?window.Promise:require("bluebird");var ConnectorV1=function(){function ConnectorV1(selector){return _classCallCheck(this,ConnectorV1),this.selector=selector,this._coder=selector.encode(),this.subscriptions=[],this.robotModel=[],this}return _createClass(ConnectorV1,[{key:"watch",value:function(robotNames,callback){var _this=this;this.selector.setMaxListeners(0),this.selector._connection.setMaxListeners(0);var sendData=[];return Promise.try(function(){_this.selector.request({service:"status",func:"GetManagedObjects",obj:{interface:"org.freedesktop.DBus.ObjectManager"}},function(peerId,err,objData){var robotName="",robotId=1;for(var objectPath in objData)if(null!=objData[objectPath]["fr.partnering.Status.Robot"]&&(robotName=objData[objectPath]["fr.partnering.Status.Robot"].RobotName,robotId=objData[objectPath]["fr.partnering.Status.Robot"].RobotId,_this.getAllStatuses(robotName,function(model){callback(model,peerId)})),null!=objData[objectPath]["fr.partnering.Status.Part"]){var subs=_this.selector.subscribe({service:"status",func:"StatusChanged",obj:{interface:"fr.partnering.Status.Part",path:objectPath},data:robotNames},function(peerId,err,data){null!=err?Logger.error("StatusSubscribe:"+err):(sendData[0]=data,_this._getRobotModelFromRecv(sendData,robotId,robotName),"function"==typeof callback&&callback(_this.robotModel,peerId))});_this.subscriptions.push(subs)}})}).catch(function(err){Logger.error(err)})}},{key:"closeSubscriptions",value:function(){for(var i in this.subscriptions)this.subscriptions[i].close();this.subscriptions=[],this.robotModel=[]}},{key:"_getRobotModelFromRecv",value:function(data,robotId,robotName){var _this2=this;null==this.robotModel&&(this.robotModel=[]),null!=this.robotModel[robotId]&&(this.robotModel[robotId].parts={}),null==this.robotModel[robotId]&&(this.robotModel[robotId]={}),this.robotModel[robotId]={robot:{name:robotName}},this.robotModel[robotId].parts={};var rParts=this.robotModel[robotId].parts;data.forEach(function(d){var partId=d[0],category=d[1],partName=d[2],label=d[3],time=d[4],code=d[5],codeRef=d[6],msg=d[7],critLevel=d[8],description=d[9];null==rParts[partId]&&(rParts[partId]={}),rParts[partId].category=category,rParts[partId].name=partName.toLowerCase(),rParts[partId].label=label,null==rParts[partId].errorList&&(rParts[partId].errorList={}),null==rParts[partId].errorList[codeRef]&&(rParts[partId].errorList[codeRef]={msg:msg,critLevel:critLevel,description:description});var evts_tmp={time:_this2._coder.from(time),code:_this2._coder.from(code),codeRef:_this2._coder.from(codeRef)};if(Array.isArray(evts_tmp.code)||Array.isArray(evts_tmp.time)||Array.isArray(evts_tmp.codeRef))if(evts_tmp.code.length===evts_tmp.codeRef.length&&evts_tmp.code.length===evts_tmp.time.length){rParts[partId].evts=[];for(var i=0;i<evts_tmp.code.length;i++)rParts[partId].evts.push({time:evts_tmp.time[i],code:evts_tmp.code[i],codeRef:evts_tmp.codeRef[i]})}else Logger.error("Status:Inconsistant lengths of buffers (time/code/codeRef)");else rParts[partId].evts=[{time:evts_tmp.time,code:evts_tmp.code,codeRef:evts_tmp.codeRef}]})}},{key:"setStatus",value:function(robotName,partName,code,source,callback){var _this3=this;return Promise.try(function(){var objectPath="/fr/partnering/Status/Robots/"+_this3._splitAndCamelCase(robotName,"-")+"/Parts/"+partName;_this3.request({service:"status",func:"SetPart",obj:{interface:"fr.partnering.Status.Part",path:objectPath},data:{code:code,source:1|source}},_this3._onSetPart.bind(_this3,callback))}).catch(function(err){Logger.error(err)})}},{key:"_onSetPart",value:function(callback,peerId,err,data){null!=err?"function"==typeof callback&&callback(!1):"function"==typeof callback&&callback(!0)}},{key:"getStatus",value:function(robotName,partName,callback){var _this4=this;return Promise.try(function(){_this4.selector.request({service:"status",func:"GetManagedObjects",obj:{interface:"org.freedesktop.DBus.ObjectManager"}},_this4.onGetManagedObjectsGetStatus.bind(_this4,robotName,partName,callback))}).catch(function(err){Logger.error(err)})}},{key:"onGetManagedObjectsGetStatus",value:function(robotName,partName,callback,peerId,err,data){var objectPathRobot="/fr/partnering/Status/Robots/"+this._splitAndCamelCase(robotName,"-"),objectPathPart="/fr/partnering/Status/Robots/"+this._splitAndCamelCase(robotName,"-")+"/Parts/"+partName,robotId=data[objectPathRobot]["fr.partnering.Status.Robot"].RobotId;this.selector.request({service:"status",func:"GetPart",obj:{interface:"fr.partnering.Status.Part",path:objectPathPart}},this._onGetPart.bind(this,robotId,robotName,callback))}},{key:"_onGetPart",value:function(robotId,robotName,callback,peerId,err,data){var sendData=[];sendData.push(data),this._getRobotModelFromRecv(sendData,robotId,robotName),null!=err?"function"==typeof callback&&callback(-1):"function"==typeof callback&&callback(this.robotModel)}},{key:"getAllStatuses",value:function(robotName,callback){this.selector.request({service:"status",func:"GetManagedObjects",obj:{interface:"org.freedesktop.DBus.ObjectManager"}},this._onGetManagedObjectsGetAllStatuses.bind(this,robotName,callback))}},{key:"_onGetManagedObjectsGetAllStatuses",value:function(robotName,callback,peerId,err,data){var objectPath="/fr/partnering/Status/Robots/"+this._splitAndCamelCase(robotName,"-");if(null!=data[objectPath])if(null!=data[objectPath]["fr.partnering.Status.Robot"]){var robotId=data[objectPath]["fr.partnering.Status.Robot"].RobotId;this.selector.request({service:"status",func:"GetAllParts",obj:{interface:"fr.partnering.Status.Robot",path:objectPath}},this._onGetAllParts.bind(this,robotId,robotName,callback))}else Logger.error("Interface fr.partnering.Status.Robot doesn't exist!");else Logger.error("ObjectPath "+objectPath+" doesn't exist!")}},{key:"_onGetAllParts",value:function(robotId,robotName,callback,peerId,err,data){if(null!=err)throw"function"==typeof callback&&callback(-1),new Error(err);this._getRobotModelFromRecv(data,robotId,robotName),"function"==typeof callback&&callback(this.robotModel)}},{key:"_splitAndCamelCase",value:function(inString,delimiter){var arraySplitString=inString.split(delimiter),outCamelString="";return arraySplitString.forEach(function(str){outCamelString+=str.charAt(0).toUpperCase()+str.substring(1)}),outCamelString}}]),ConnectorV1}();module.exports=ConnectorV1},{bluebird:void 0}],8:[function(require,module,exports){"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),debug=require("debug")("status:connector"),Watcher=require("./watcher.js"),ConnectorV1=require("../v1/connector.js"),ConnectorV2=function(_ConnectorV){function ConnectorV2(selector){var _ret;_classCallCheck(this,ConnectorV2);var _this=_possibleConstructorReturn(this,(ConnectorV2.__proto__||Object.getPrototypeOf(ConnectorV2)).call(this,selector));return _this.watchers=[],_ret=_this,_possibleConstructorReturn(_this,_ret)}return _inherits(ConnectorV2,_ConnectorV),_createClass(ConnectorV2,[{key:"watch",value:function(options,callback){var _this2=this;if(null==callback||"function"!=typeof callback)return null;var watcher=new Watcher(this.selector,options);return this.watchers.push(watcher),watcher.on("data",function(data){debug(data),callback(_this2._getRobotModelFromRecv(data.parts,data.robotId,data.robotName),data.peerId)}),watcher.on("stop",this._removeWatcher),watcher}},{key:"_removeWatcher",value:function(watcher){this.watchers.find(function(el,id,watchers){return watcher===el&&(watchers.splice(id,1),!0)})}},{key:"stopWatchers",value:function(){var _this3=this;this.watchers.forEach(function(watcher){watcher.removeListener("stop",_this3._removeWatcher),watcher.stop()}),this.watchers=[]}},{key:"closeSubscriptions",value:function(){console.warn("Deprecared function, use stopWatchers instead"),this.stopWatchers()}},{key:"_getRobotModelFromRecv",value:function(data,robotId,robotName){var _this4=this;null==this.robotModel&&(this.robotModel=[]),null!=this.robotModel[robotId]&&(this.robotModel[robotId].parts={}),null==this.robotModel[robotId]&&(this.robotModel[robotId]={}),this.robotModel[robotId]={robot:{name:robotName}},this.robotModel[robotId].parts={};var rParts=this.robotModel[robotId].parts;return data.forEach(function(d){var partId=d[0],category=d[1],partName=d[2],label=d[3],time=d[4],code=d[5],codeRef=d[6],msg=d[7],critLevel=d[8],description=d[9];null==rParts[partId]&&(rParts[partId]={}),rParts[partId].category=category,rParts[partId].name=partName.toLowerCase(),rParts[partId].label=label,null==rParts[partId].errorList&&(rParts[partId].errorList={}),null==rParts[partId].errorList[codeRef]&&(rParts[partId].errorList[codeRef]={msg:msg,critLevel:critLevel,description:description});var evts_tmp={time:_this4._coder.from(time),code:_this4._coder.from(code),codeRef:_this4._coder.from(codeRef)};null==rParts[partId].evts&&(rParts[partId].evts=[]),rParts[partId].evts.push(evts_tmp)}),this.robotModel}}]),ConnectorV2}(ConnectorV1);module.exports=ConnectorV2},{"../v1/connector.js":7,"./watcher.js":9,debug:1}],9:[function(require,module,exports){"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),EventEmitter=require("eventemitter3"),debug=require("debug")("status:watcher"),debugError=require("debug")("status:watcher:errors"),StopCondition=function(_Error){function StopCondition(msg){_classCallCheck(this,StopCondition);var _this=_possibleConstructorReturn(this,(StopCondition.__proto__||Object.getPrototypeOf(StopCondition)).call(this,msg));return _this.name="StopCondition",_this}return _inherits(StopCondition,_Error),StopCondition}(Error),Watcher=function(_EventEmitter){function Watcher(selector,options){_classCallCheck(this,Watcher);var _this2=_possibleConstructorReturn(this,(Watcher.__proto__||Object.getPrototypeOf(Watcher)).call(this));return _this2.selector=selector,_this2.subscriptions=[],_this2.state="running",_this2.reconnectionPeriod=0,_this2.maxReconnectionPeriod=6e4,_this2.selector.setMaxListeners(0),_this2.selector._connection.setMaxListeners(0),null==options.signal&&(options.signal="StatusesBuffered"),_this2._statusesDictionary={},debug(options),_this2.watch(options),_this2}return _inherits(Watcher,_EventEmitter),_createClass(Watcher,[{key:"watch",value:function(options){var _this3=this;debug("in watch"),new Promise(function(resolve,reject){_this3.selector.request({service:"status",func:"GetManagedObjects",obj:{interface:"org.freedesktop.DBus.ObjectManager"}},function(peerId,err,data){if(null!=err)return void reject(err);if("stopped"===_this3.state)return void reject(new StopCondition);debug("Request:emitData"),debug(data),data=_this3._parseGetManagedObjectsData(data),debug(data);for(var deviceName in data.devices){var device=data.devices[deviceName];if(0===device.parts.length)return void reject("Error: No part yet");var dataToEmit={parts:device.parts,robotId:device.robotId,robotName:device.robotName,peerId:peerId};_this3.emit("data",dataToEmit)}resolve()})}).then(function(){return new Promise(function(resolve,reject){_this3.selector.request({service:"status",func:"Get",obj:{interface:"org.freedesktop.DBus.Properties",path:"/fr/partnering/Status"},data:{interface_name:"fr.partnering.Status",property_name:"StatusesDictionary"}},function(peerId,err,data){return null!=err?void reject(err):"stopped"===_this3.state?void reject(new StopCondition):null==data?void reject("No StatusesDictionary data"):(_this3._statusesDictionary=data,void resolve())})})}).then(function(){return debug("Subscribing"),new Promise(function(resolve,reject){var subscription=_this3.selector.subscribe({service:"status",func:options.signal},function(peerId,err,data){if(null!=err)return void reject(err);if(null!=data){data=_this3._parseStatusChangedData(data[0]);for(var deviceName in data.devices){var device=data.devices[deviceName],dataToEmit={parts:device.parts,robotId:device.robotId,robotName:device.robotName,peerId:peerId};_this3.emit("data",dataToEmit)}}_this3.reconnectionPeriod=0,resolve()});_this3.subscriptions.push(subscription)})}).catch(function(err){"StopCondition"!==err.name&&(debugError(err),_this3._closeSubscriptions(),_this3.reconnectionPeriod=_this3.reconnectionPeriod+1e3,_this3.reconnectionPeriod>_this3.maxReconnectionPeriod&&(_this3.reconnectionPeriod=_this3.maxReconnectionPeriod),_this3.watchTentative=setTimeout(function(){_this3.watch(options)},_this3.reconnectionPeriod))})}},{key:"_parseGetManagedObjectsData",value:function(data){var peers=this.selector._connection.peers().map(function(peer){return peer.toLowerCase().replace("-","")}),parsedData={devices:{}};if(null==data)return parsedData;for(var path in data){var obj=data[path],splitPath=path.split("/");if(6===splitPath.length){for(var iface in obj)if("fr.partnering.Status.Robot"===iface){var robotName=splitPath[5].toLowerCase();if(peers.includes(robotName)){var device=obj[iface],selDevice=parsedData.devices[robotName];null==selDevice&&(selDevice={parts:[]},parsedData.devices[robotName]=selDevice),selDevice.robotName=device.RobotName,selDevice.robotId=device.RobotId}}}else if(8===splitPath.length){for(var _iface in obj)if("fr.partnering.Status.Part"===_iface){var _robotName=splitPath[5].toLowerCase();if(peers.includes(_robotName)){var part=obj[_iface],_selDevice=parsedData.devices[_robotName];null==_selDevice&&(_selDevice={parts:[]},parsedData.devices[_robotName]=_selDevice);var newPart=[];newPart[0]=part.PartId,newPart[1]=part.Category,newPart[2]=part.PartName,newPart[3]="",newPart[4]=part.Time,newPart[5]=part.Code,newPart[6]=part.CodeRef,newPart[7]=part.Msg,newPart[8]=part.CritLevel,newPart[9]="",_selDevice.parts.push(newPart)}}}else debugError("Undefined path format")}return parsedData}},{key:"_parseStatusChangedData",value:function(data){var _this4=this,parsedData={};return data.forEach(function(event){var robotName=event[0],robotId=event[1],time=event[2],statusEventId=event[3],code=event[4],robotNameLowerCase=robotName.toLowerCase();if(_this4._statusesDictionary[statusEventId][0]!==statusEventId)return void console.error("Malformed statuses dictionary");var partId=_this4._statusesDictionary[statusEventId][1],codeRef=_this4._statusesDictionary[statusEventId][2],partName=_this4._statusesDictionary[statusEventId][3],category=_this4._statusesDictionary[statusEventId][4],msg=_this4._statusesDictionary[statusEventId][5],critLevel=_this4._statusesDictionary[statusEventId][6];null==parsedData.devices&&(parsedData.devices=[]),null==parsedData.devices[robotNameLowerCase]&&(parsedData.devices[robotNameLowerCase]={}),parsedData.devices[robotNameLowerCase].robotId=robotId,parsedData.devices[robotNameLowerCase].robotName=robotName,null==parsedData.devices[robotNameLowerCase].parts&&(parsedData.devices[robotNameLowerCase].parts=[]);var newPart=[];newPart[0]=partId,newPart[1]=category,newPart[2]=partName,newPart[3]="",newPart[4]=time,newPart[5]=code,newPart[6]=codeRef,newPart[7]=msg,newPart[8]=critLevel,newPart[9]="",parsedData.devices[robotNameLowerCase].parts.push(newPart)}),parsedData}},{key:"_closeSubscriptions",value:function(){debug("In closeSubscription");for(var i in this.subscriptions)this.subscriptions[i].close();this.subscriptions=[]}},{key:"stop",value:function(){
debug("In stop"),this.state="stopped",null!=this.watchTentative&&clearTimeout(this.watchTentative),this._closeSubscriptions(),this.emit("stop"),this.removeAllListeners()}}]),Watcher}(EventEmitter);module.exports=Watcher},{debug:1,eventemitter3:3}]},{},[6]);
